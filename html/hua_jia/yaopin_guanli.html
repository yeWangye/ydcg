<!DOCTYPE html>
<html>

<head>
    <title>划价系统</title>
    <meta charset="utf-8">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:300,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700,900' rel='stylesheet' type='text/css'>
    <!-- CSS Libs -->
    <link rel="stylesheet" type="text/css" href="../../lib/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/bootstrap-switch.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/checkbox3.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/dataTables.bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/select2.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/pagination.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/jquery.mloading.css">

    <!-- CSS App -->
    <link rel="stylesheet" type="text/css" href="../../css/style.css">
    <link rel="stylesheet" type="text/css" href="../../css/themes/flat-blue.css">
    <link rel="stylesheet" type="text/css" href="../../css/themes/flat-green.css">
    <style>
        input{
            margin:0;
        }
        .select2-container--default .select2-results>.select2-results__options{
            max-height: 500px;
        }
        .iconBox{
            position: relative;
            margin: 4px 5px 0 0;
            padding: 0 19px 0 4px;
            max-width: 100%;
            white-space: nowrap;
            /*overflow: hidden;*/
            text-overflow: ellipsis;
            border: 1px solid #e8e8e8;
            height: 38px;
            line-height: 38px;
            color: #666;
            text-decoration: none;
        }
        .iconBox:hover{
            border-color: #f40;
        }
        .isDel,.medicineName,.pageBox{
            display: none;
        }
        .selectBox input{
            margin: 0;
            padding: 0;
            border: 0;
            float: none;
            margin: 0 5px;
            width: 60%;
            height: 100%;
            line-height: 38px;
            text-align: left;
            background: #fff;
            /*border: 1px solid #ebebeb;*/
            outline: none;
            color: #bdbdbd;
            font-size: 14px;
        }
        .pay_time{
            width:80%!important;
        }
        .icon-btn-x{
            color: red;
            cursor: pointer;
            /* position: absolute; */
            /* right: 0px; */
            border: 1px solid red;
            border-radius: 5px;
            padding: 5px;
        }
        .select2-results{
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        .lable{
            color:blue;
        }
    </style>
</head>

<body class="flat-blue">
<div class="app-container">
    <div class="row content-container">
        <div class="row content-container">
            <nav id="navbar" class="navbar navbar-default navbar-fixed-top navbar-top">
                <div class="container-fluid" style="text-align: center;">
                    <div class="navbar-header">
                        <button type="button" class="navbar-expand-toggle">
                            <i class="fa fa-bars icon"></i>
                        </button>
                        <ol class="breadcrumb navbar-breadcrumb">
                            <li>添加药品</li>
                        </ol>

                    </div>
                    <ul class="nav navbar-nav navbar-right">
                        <button type="button" class="navbar-right-expand-toggle pull-right visible-xs">
                            <i class="fa fa-times icon"></i>
                        </button>
                        <li class="dropdown danger">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                               aria-expanded="false"><i class="fa fa-star-half-o"></i><span
                                    class=" totalMsg"></span></a>
                        </li>
                        <li class="dropdown profile">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                               aria-expanded="false"><span class="username"></span> <span class="caret"></span></a>
                            <ul class="dropdown-menu animated fadeInDown">
                                <li class="profile-img">
                                    <img src="../../img/profile/picjumbo.com_HNCK4153_resize.jpg" class="profile-img">
                                </li>
                                <li>
                                    <div class="profile-info">
                                        <h4 class="username"></h4>
                                        <p style="color: red;"><span class="role"></span> ←→ <span
                                                class="teamName"></span></p>
                                        <div class="btn-group margin-bottom-2x" role="group">
                                            <button type="button" class="btn btn-default headimg_exchange"><i
                                                    class="fa fa-user"></i> 更换头像
                                            </button>
                                            <button type="button" class="btn btn-default logout"><i
                                                    class="fa fa-sign-out"></i> 退出登陆
                                            </button>
                                            <input type="file" accept="image/*" style="display: none;"
                                                   name="headimg_exchange" id="headimg_exchange"/>

                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>
            <div id="sidebar" class="side-menu sidebar-inverse">

            </div>
            <!-- Main Content -->
            <div class="container-fluid">
                <div class="side-body">
                    <div class="page-title">
                        <div class="page-title">
                            <span class="title">药品管理</span>
                            <div class="description">
                                <span class="tips">操作提示:</span>当前获取到的是<span class="tips">会计</span>药品管理界面!
                                <br>
                                <span class="tips">筛选条件:</span>根据情况自行添加<span class="tips">需要参与筛选的条目!</span>
                            </div>
                            <div>
                                <lable style="color:blue;">筛选条件:</lable>
                                <select id="select"  style="width:25%" title="筛选" aria-describedby="basic-addon1">
                                    <optgroup label="请选择筛选条件">
                                        <option value="isDel">是否删除</option>
                                        <option value="medicineName">药品名字</option>
                                        <option value="page">单页显示数</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="card">
                                <div class="card-header col-xs-12" style="text-align: center;">
                                    <div>
                                        <div class="col-xs-4 selectBox">
                                            <a class="isDel iconBox" data-obj="isDel" style="max-width: 100%;">
                                                <span class="lable">是否删除：</span>
                                                <select id="isDel" style="width:60%;" title="状态" aria-describedby="basic-addon1">
                                                    <optgroup label="请选择状态">
                                                        <option value="0">未删除</option>
                                                        <option value="1">已删除</option>
                                                    </optgroup>
                                                </select>
                                                <span class="icon-btn-x">删除</span>
                                            </a>
                                            <a class="medicineName iconBox"  data-obj="medicineName">
                                                <span class="lable">药品名字：</span>
                                                <input class="medicine_name" value="" type="text">
                                                <span class="icon-btn-x">删除</span>
                                            </a>
                                            <a class="pageBox iconBox"  data-obj="page">
                                                <span class="lable">显示数：</span>
                                                <input class="page" value="" type="number">
                                                <span class="icon-btn-x">删除</span>
                                            </a>
                                        </div>
                                        <div class="card-title col-xs-5">
                                            <div class="title"><button class="btn btn-success searchBtn" style="border:1px solid;border-radius: 20px;width:100%;">查询</button></div>
                                        </div>
                                        <div class="card-title col-xs-3">
                                            <button type="submit" onclick="method5('tableExcel','name','药品价格.xls')" class="btn btn-primary" style="float:right;"><a id="dlink" href="" style="display: none;"></a><i class="fa fa-download"></i> 导出表格
                                            </button>
                                        </div>
                                    </div>
                                    </div>
                                    <div class="card-title" style="float:right;text-align: center;">
                                        <div class="">
                                            <a class="btn btn-primary add_yao" style="color:white;display: block;">添加药品<span
                                                    class="fa fa-chevron-circle-right"></span></a>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <table class="table table-striped" cellspacing="0" width="100%" id="tableExcel">
                                        <thead>
                                        <tr>
                                            <th>序号</th>
                                            <th>药品</th>
                                            <th>进价</th>
                                            <th>售价</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                    <div class="M-box"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="add_yao" tabindex="-2" role="dialog" aria-labelledby="addKeshiModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">添加药品</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group col-xs-12">
                            <div class="col-xs-3">
                                <lable for="departName"
                                       style="height:38px;line-height: 38px;width:100%;color:red;font-size: 18px;">药品名称：
                                </lable>
                            </div>
                            <input type="text" id="medicineName" class="col-xs-5">
                            <input type="hidden" id="mId" class="col-xs-5">
                        </div>
                        <div class="form-group col-xs-12">
                            <div class="col-xs-3">
                                <lable for="buyPrice"
                                       style="height:38px;line-height: 38px;width:100%;color:red;font-size: 18px;">进价：
                                </lable>
                            </div>
                            <input type="number" id="buyPrice" class="col-xs-5">
                        </div>
                        <div class="form-group col-xs-12">
                            <div class="col-xs-3">
                                <lable for="salePrice"
                                       style="height:38px;line-height: 38px;width:100%;color:red;font-size: 18px;">售价：
                                </lable>
                            </div>
                            <input type="number" id="salePrice" class="col-xs-5">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary save">保存</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="app-footer">
                <div class="wrapper">
                    <span class="pull-right">1.0 <a href="#"><i class="fa fa-long-arrow-up"></i></a></span> © 2017
                    Copyright. 期待更多
                    <a href="http://http://www.bj11ss.com/" target="_blank" title="医来伸手">顺昌盛世</a>
                    <a href="http://www.bj11ss.com/" title="医来伸手" target="_blank">----医来伸手</a>
                </div>
            </footer>
            <div>
                <!-- Javascript Libs -->
                <script type="text/javascript" src="../../lib/js/jquery.min.js"></script>
                <script type="text/javascript" src="../../lib/js/bootstrap.min.js"></script>
                <script type="text/javascript" src="../../lib/js/Chart.min.js"></script>
                <script type="text/javascript" src="../../lib/js/bootstrap-switch.min.js"></script>

                <script type="text/javascript" src="../../lib/js/jquery.matchHeight-min.js"></script>
                <script type="text/javascript" src="../../lib/js/jquery.dataTables.min.js"></script>
                <script type="text/javascript" src="../../lib/js/dataTables.bootstrap.min.js"></script>
                <script type="text/javascript" src="../../lib/js/select2.full.min.js"></script>

                <script src="../../lib/js/jquery.pagination.js"></script>
                <!-- Javascript -->
                <script type="text/javascript" src="../../js/app.js"></script>
                <script src="../../js/dateFormat.js"></script>
                <script type="text/javascript" src="../../js/theming.js"></script>
                <script type="text/javascript" src="../../js/themings.js"></script>
                <script type="text/javascript" src="../../lib/js/jquery.mloading.js"></script>
                <script type="text/javascript" src="../../js/excel.js"></script>

                <script src="../../js/config.js"></script>
                <script src="../../js/uploadImg.js"></script>
                <script src="../../js/session_expire.js"></script>
                <script src="../../js/floatObj.js"></script>
                <script type="text/javascript" src="../../js/personal_msg.js"></script>

                <script type="text/javascript">
                    $(document).ready(function () {
                        var json_data={};
                        $('#select').val("").select2({
                            placeholder: "请选择筛选条件"
                        });
                        $("#isDel").select2({
                            placeholder: "请选择是否删除"
                        });
                        if (session_login.info.roleId == "1") {
                            alert("组员没有机会访问本页面,请尽快升职加薪哦,我等你!");
                            window.location.href = "../index.html";
                            return;
                        }
                        // 删除
                        $('.table tbody').on('click', 'button.del', function (e) {
                            e.stopPropagation();
                            e.preventDefault();
                            var mId = $(this).parents("tr").attr("data-mid");
                            if (confirm("确认删除该药品?")) {
                                $.ajax({
                                    url: config.rootUrl + "user/delMedicine.do",
                                    type: 'POST',
                                    dataType: 'json',
                                    data: {
                                        deviceToken: "html5",
                                        deviceType: "html5",
                                        userId: session_login.info.userId,
                                        mId: mId,
                                    },
                                    success: function (data) {
                                        if (data.code == 1) {
                                            alert("删除成功!");
                                            window.location.reload();
                                        } else {
                                            alert(data.msg);
                                        }
                                    },
                                    error: function () {
                                        alert("发生错误!");
                                    }
                                })
                            }
                        });
                        // 修改
                        $('.table tbody').on('click', 'button.set', function (e) {
                            e.stopPropagation();
                            e.preventDefault();
                            var mId = $(this).parents("tr").attr("data-mid");
                            var medicineName = $(this).parents("tr").attr("data-medicineName");
                            var buyPrice = $(this).parents("tr").attr("data-buyPrice");
                            var salePrice = $(this).parents("tr").attr("data-salePrice");
                            $("#mId").val(mId);
                            $("#medicineName").val(medicineName);
                            $("#buyPrice").val(buyPrice);
                            $("#salePrice").val(salePrice);
                            $('#add_yao').modal();
                        });
                        $("#buyPrice").on("input",function(){
                            var _buyprice=$(this).val();
                            var _salePrice=numMulti(_buyprice, 3);
                            $("#salePrice").val(_salePrice);
                        })
                        $('.save').on('click', function (mId) {
                            var medicineName = $("#medicineName").val();
                            var buyPrice = $("#buyPrice").val();
                            if(buyPrice==""){
                                alert("进价必须填写！");
                            }
                            var salePrice=$("#salePrice").val()||numMulti(_buyprice, 3);
                            var mId= $("#mId").val();
                            $.ajax({
                                url: config.rootUrl + "user/addMedicine.do",
                                data: {
                                    deviceToken: "html5",
                                    deviceType: "html5",
                                    userId: session_login.info.userId,
                                    medicineName: medicineName,
                                    buyPrice: buyPrice,
                                    salePrice: salePrice,
                                    mid: mId||"",
                                },
                                async: true,
                                type: "post",
                                success: function (data) {
                                    alert(data.msg);
                                    if(data.code=="1"){
                                        if(mId){
                                            $("#mId").val("");
                                        }
                                        window.location.reload();
                                    }
                                },
                                error: function () {
                                    alert("发生错误");
                                },
                            })
                        });
                        $("#select").on("select2:close", function(e) {
                            var val = $(this).val();
                            switch(val){
                                case "medicineName":
                                    $(".medicineName").css("display","block");
                                    if(!json_data.medicineName){
                                        json_data.medicineName="";
                                        $(".medicine_name").val("");
                                    }
                                    break;
                                case "isDel":
                                    $(".isDel").css("display","block");
                                    if(!json_data.isDel){
                                        json_data.isDel="";
                                        $(".isDel").val("");
                                    }
                                    break;
                                case "page":
                                    $(".pageBox").css("display","block");
                                    if(!json_data.page){
                                        json_data.page="";
                                        sessionStorage.removeItem("rows");
                                        $(".page").val("");
                                    }
                                    break;
                            }
                        });
                        // 是否删除
                        $("#isDel").on("select2:close",function(){
                            var isDel=$(this).val();
                            json_data.isDel=isDel;
                        });
                        // 药名
                        $(".medicine_name").on("blur",function(){
                            var medicine_name=$(this).val();
                            json_data.medicineName=medicine_name;
                        });
                        // 分页
                        $(".page").on("blur",function(){
                            var page=$(this).val();
                            json_data.page=page;
                            sessionStorage.setItem("rows",page);
                        });
                        $('.add_yao').on('click', function(e) {
                            $("#medicineName").val("");
                            $("#buyPrice").val("");
                            $("#salePrice").val("");
                            $('#add_yao').modal();
                        });
                        $(".icon-btn-x").on("click",function(){
                            $(this).parents("a").css("display","none");
                            var json_obj=$(this).parents("a").attr("data-obj");
                            delete json_data[json_obj];
                        });
                        if(sessionStorage.getItem("rows")){
                            $(".page").val(sessionStorage.getItem("rows"));
                            $(".pageBox").css("display","block");
                        }
                        $(".searchBtn").on("click",function(){
                            sessionStorage.setItem("page",1)
                            doAjax(json_data);
                        });
                        doAjax();
                        function doAjax() {
                            $("body").mLoading("show");
                            var page=sessionStorage.getItem("page")||1;
                            var rows=sessionStorage.getItem("rows")||15;
                            $(".table tbody")[0].innerHTML = "";
                            $.ajax({
                                url: config.rootUrl + "user/listMedicine.do",
                                data: {
                                    deviceToken: "html5",
                                    deviceType: "html5",
                                    userId: session_login.info.userId,
                                    medicineName:json_data.medicineName||"",
                                    isDel:json_data.isDel||"",
                                    page: page||"1",
                                    rows: rows,
                                },
                                async: true,
                                type: 'post',
                                success: function (data) {
                                    var _counter=(page-1)*rows+1;
                                    var info = data.info;
                                    var pageCount = data.pageCount;
                                    var tbody = $(".table tbody")[0];
                                    for (var i = 0; i < info.length; i++) {
                                        var buyPrice=info[i].buyPrice||0;
                                        var salePrice=info[i].salePrice||0;
                                        var _dom="<button  class='btn btn-danger del' type='button'><i class='fa fa-trash-o'></i> 删除 </button> "+
                                            "<button  class='btn btn-success set' type='button'><i class='fa fa-tag'></i> 修改 </button> ";
                                        tbody.innerHTML += "<tr data-mid='" + info[i].mId + "' data-medicineName="+info[i].medicineName+" data-buyPrice="+buyPrice+" data-salePrice="+salePrice+" style='cursor:pointer'>" +
                                            "<td class='goDetail'>" + _counter +"</td>" +
                                            "<td class='goDetail'>" + info[i].medicineName + "</td>" +
                                            "<td class='goDetail'>" + buyPrice + "</td>" +
                                            "<td class='goDetail'>" + salePrice + "</td>" +
                                            "<td class='goDetail'>" + _dom + "</td>" +
                                            "</tr>";
                                        _counter++;
                                    }
                                    //添加选项内容
                                    $('.M-box').pagination({
                                        pageCount: pageCount,
                                        showData: 10,
                                        jump: true,
                                        coping: true,
                                        homePage: '首页',
                                        endPage: '末页',
                                        prevContent: '上页',
                                        nextContent: '下页',
                                        current:page||1,
                                        callback: function (api) {
                                            sessionStorage.setItem("page",api.getCurrent());
                                            $("body").mLoading("show");
                                            $.ajax({
                                                url: config.rootUrl + "user/listMedicine.do",
                                                data: {
                                                    deviceToken: "html5",
                                                    deviceType: "html5",
                                                    userId: session_login.info.userId,
                                                    medicineName:json_data.medicineName||"",
                                                    isDel:json_data.isDel||"",
                                                    page: api.getCurrent()||1,
                                                    rows: rows,
                                                },
                                                async: true,
                                                type: "post",
                                                success: function (data) {
                                                    var info = data.info;
                                                    _counter=(api.getCurrent()-1)*rows;
                                                    var tbody = $(".table tbody")[0];
                                                    tbody.innerHTML = "";
                                                    //添加选项盒子
                                                    for (var i = 0; i < info.length; i++) {
                                                        _counter++;
                                                        var buyPrice=info[i].buyPrice||0;
                                                        var salePrice=info[i].salePrice||0;
                                                        var _dom="<button  class='btn btn-danger del' type='button'><i class='fa fa-trash-o'></i> 删除 </button> "+
                                                            "<button  class='btn btn-success set' type='button'><i class='fa fa-tag'></i> 修改 </button> ";
                                                        tbody.innerHTML += "<tr data-mid='" + info[i].mId + "'data-medicineName="+info[i].medicineName+" style='cursor:pointer'>" +
                                                            "<td class='goDetail'>" + _counter +"</td>" +
                                                            "<td class='goDetail'>" + info[i].medicineName + "</td>" +
                                                            "<td class='goDetail'>" + buyPrice + "</td>" +
                                                            "<td class='goDetail'>" + salePrice + "</td>" +
                                                            "<td class='goDetail'>" + _dom + "</td>" +
                                                            "</tr>";
                                                    }
                                                },
                                                error: function () {
                                                    alert("网络错误");
                                                },
                                                complete: function () {
                                                    $("body").mLoading("hide");
                                                }
                                            })
                                        }

                                    });

                                },
                                error: function (xhr, type, errorThrown) {
                                    alert('网络异常，请稍后再试！');
                                },
                                complete: function () {
                                    $("body").mLoading("hide");
                                }
                            });
                        }

                    })
                </script>
</body>

</html>